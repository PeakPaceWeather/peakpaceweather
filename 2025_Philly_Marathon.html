<!DOCTYPE html>
<html lang="en">
<head>
  <!-- AACR Philadelphia Marathon - Peak Pace Weather Forecast -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>AACR Philadelphia Marathon | Peak Pace Weather</title>

  <!-- Fonts & Libraries -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
/* ===== Base + Responsive ===== */
html, body { overflow-x: hidden; touch-action: pan-x pan-y; zoom: 1; }
body { margin: 0; padding: 0; font-family: "Source Sans Pro", Arial, sans-serif; color: #111; background: #fff; line-height: 1.5; }
:root { --ink:#111; --muted:#555; --line:#ddd; --pp-dark:#003546; --blaze:#37BC7D; --highlight:#FF6700; --hoverRow:#fff3e6; }

/* ===== Layout + Header ===== */
.page-wrapper { width: 1000px; margin: 0 auto; padding: 0; box-sizing: border-box; }
.main-header { text-align: center; font-family: "Montserrat", sans-serif; font-weight: 800; font-size: clamp(36px, 6vw, 52px); letter-spacing: .05em; text-transform: uppercase; color: #000; margin: 28px 0 18px; line-height: 1; }
header { text-align:center; margin:8px auto 14px; }
header h2 { margin:0; font-size:32px; font-weight:700; }
#countdown { font-size:20px; font-weight:600; margin-top:6px; color:#333; }

/* ===== Panels ===== */
section, #elevSection, #map, #paceBox, #stationToggleBox { width: 960px; max-width: 960px; margin: 18px auto 0; box-sizing: border-box; }
section, #elevSection, #stationToggleBox { border:1px solid #ccc; border-radius:8px; background:#fff; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
section:last-of-type { margin-bottom:24px; }
section h3 { text-align:center; margin:0 0 12px; font-size:20px; font-weight:700; }

#map { height: 600px; margin-top:10px; border:1px solid #ccc; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }

/* Elevation */
#elevSection { width: 960px; max-width: 960px; margin: 18px auto; border: 1px solid #ccc; border-radius: 8px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); padding: 16px; box-sizing: border-box; }
#elevWrap { position:relative; width:100%; height:225px; margin:0 auto; padding:0; box-sizing:border-box; }
#elevationChart { position:absolute; inset:0; width:100% !important; height:100% !important; display:block; box-sizing:border-box; cursor:pointer; }

/* Station Toggle Box */
#stationToggleBox {
  padding: 20px;
  margin: 18px auto;
}
#stationToggleBox h3 { margin-top: 0; }
.toggle-group {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  margin: 15px 0;
}
.radio-option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}
.radio-option input[type="radio"] {
  cursor: pointer;
  width: 18px;
  height: 18px;
}
.radio-option label {
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  margin: 0;
}
.toggle-note {
  font-size: 12px;
  color: #FF6700;
  text-align: center;
  margin-top: 12px;
  font-style: italic;
}

/* Pace Box */
#paceBox { text-align:center; padding:10px 12px; margin:10px auto 0; background:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
#paceControls { display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }
#paceControls label { font-size:14px; font-weight:600; color:#000; }
#paceControls select { font-size:13px; border:1px solid var(--pp-dark); border-radius:6px; padding:4px 6px; background:#fff; color:var(--ink); cursor:pointer; min-width:110px; }
#paceControls button { font-size:13px; font-weight:600; border:1px solid var(--pp-dark); border-radius:6px; color:#fff; background:var(--pp-dark); cursor:pointer; padding:6px 10px; transition:background .2s ease; }
#paceControls button:hover:not(:disabled) { background:var(--highlight); }
#paceControls button:disabled { opacity: 0.5; cursor: not-allowed; }
#paceConfirm { font-size:13px; color:var(--muted); margin-left:6px; }

/* Corral/Pace Box Styling */
#paceBox {
  padding: 20px 24px;
  margin: 18px auto;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  width: 960px;
  max-width: 960px;
}
#corralRow, #paceRow {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}
#corralRow {
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid #eee;
}
#corralRow label, #paceRow label {
  font-weight: 700;
  color: #000;
  font-size: 15px;
}
#corralSelect, #paceMin, #paceSec {
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #fff;
  color: #111;
  padding: 8px 12px;
  cursor: pointer;
  height: 38px;
}
#corralSelect {
  min-width: 380px;
}
#paceMin, #paceSec {
  min-width: 65px;
  width: 65px;
}
.pace-input-group {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.pace-input-group span {
  color: #666;
  font-size: 16px;
  font-weight: 700;
}
#paceGo {
  font-size: 14px;
  font-weight: 600;
  border: 1px solid #003546;
  border-radius: 6px;
  color: #fff;
  background: #003546;
  cursor: pointer;
  padding: 9px 20px;
  height: 38px;
  transition: background 0.2s ease;
  margin-left: 4px;
}
#paceGo:hover:not(:disabled) { background: #FF6700; }
#paceGo:disabled { opacity: 0.5; cursor: not-allowed; }
#paceConfirm {
  font-size: 14px;
  color: #888;
  margin-left: 12px;
  font-style: italic;
}
#paceConfirm.success {
  color: #37BC7D;
  font-style: normal;
  font-weight: 500;
}

/* Tables */
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; font-size:14px; }
th { background:#f0f0f0; font-weight:700; }

/* Hover */
#forecastBody tr:hover { background: var(--hoverRow); }

/* Tap highlight */
#forecastBody tr { cursor: pointer; -webkit-tap-highlight-color: transparent; }
.highlight-row { background: var(--hoverRow) !important; box-shadow: inset 0 0 0 2px var(--highlight); transition: background .2s ease, box-shadow .2s ease; }

.note { font-size:12px; text-align:center; margin-top:8px; color:var(--muted); }

/* Leaflet styles */
.leaflet-marker-icon { cursor:pointer; transition: transform 150ms ease; }
.leaflet-marker-icon:hover { transform: scale(1.2); }
.leaflet-tooltip { background:#fff; border:2px solid var(--highlight); border-radius:8px; color:var(--ink); font-size:13px; font-weight:500; line-height:1.4; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:6px 10px; }
.leaflet-control a { background-color:var(--pp-dark) !important; color:#fff !important; border:1px solid var(--pp-dark) !important; width:30px !important; height:30px !important; line-height:30px !important; text-align:center; font-size:16px; }
.leaflet-control a:hover { background-color: var(--blaze) !important; border-color: var(--blaze) !important; }

/* Blaze markers */
.blaze-dot { width:20px; height:20px; background:var(--blaze); border:2px solid #222; border-radius:50%; transition:transform .2s ease; transform-origin:center; }
.blaze-dot:hover { transform: scale(1.4); cursor:pointer; }
.blaze-dot.highlighted { transform: scale(1.6); background: var(--highlight); }

/* Leaflet container */
.leaflet-container { scroll-margin-top:0; scroll-behavior:auto; }
.leaflet-container:focus { outline:none; scroll-margin-top:0; }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="main-header">PEAK PACE WEATHER</div>

    <header>
      <h2>AACR Philadelphia Marathon 2025</h2>
      <div id="countdown">Loading countdown…</div>
    </header>

    <!-- Station Frequency Toggle -->
    <section id="stationToggleBox">
      <h3>Weather Station Frequency</h3>
      <div class="toggle-group">
        <div class="radio-option">
          <input type="radio" id="opt1" name="stationFreq" value="option1">
          <label for="opt1">Every Mile (27 stations)</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="opt2" name="stationFreq" value="option2">
          <label for="opt2">Every 5K (9 stations)</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="opt3" name="stationFreq" value="option3" checked>
          <label for="opt3">Official Aid Stations (16 stations)</label>
        </div>
      </div>
      <div id="toggleNote" class="toggle-note"></div>
    </section>

    <!-- Map -->
    <div id="map"></div>

    <!-- Elevation -->
    <section id="elevSection">
      <h3>Elevation Profile</h3>
      <div id="elevWrap">
        <canvas id="elevationChart"></canvas>
      </div>
    </section>

    <!-- Pace -->
    <div id="paceBox">
      <div id="corralRow">
        <label for="corralSelect">Corral/Start Time:</label>
        <select id="corralSelect"></select>
      </div>
      <div id="paceRow">
        <label for="paceMin">Target Pace (min/mi):</label>
        <div class="pace-input-group">
          <select id="paceMin"></select>
          <span>:</span>
          <select id="paceSec"></select>
        </div>
        <button id="paceGo">Generate Peak Pace Forecast</button>
        <div id="paceConfirm"></div>
      </div>
    </div>

    <!-- Forecast -->
    <section id="forecastSection">
      <h3>Peak Pace Forecast</h3>
      <div id="forecastValidLabel" style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;"></div>
      <div id="sourceLabel" style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;"></div>
      <table id="forecastTable">
        <thead>
          <tr>
            <th>Location</th>
            <th>Distance</th>
            <th>Elapsed Time</th>
            <th>ETA</th>
            <th>Temperature</th>
            <th>Wind</th>
            <th>Conditions</th>
          </tr>
        </thead>
        <tbody id="forecastBody"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ============================================================
    // EMBEDDED DATA - All route and station data
    // ============================================================
    const PHILLY_ROUTE = [[39.962120000000006, -75.17641], [39.96157167873861, -75.17565996991296], [39.961023352643885, -75.17490995185526], [39.960475021716, -75.17415994582656], [39.959926685955146, -75.17340995182654], [39.959378345361465, -75.1726599698549], [39.958830000000006, -75.17191000000001], [39.958560000000006, -75.17157], [39.95837, -75.17143], [39.957770000000004, -75.1713], [39.95768, -75.17125], [39.957550000000005, -75.17113], [39.957440000000005, -75.17098], [39.957390000000004, -75.17077], [39.95738, -75.17061000000001], [39.957300000000004, -75.17009], [39.95712, -75.16967000000001], [39.95698, -75.16941], [39.95676, -75.16906], [39.956163338884636, -75.16825998611112], [39.95556667227047, -75.16745998618174], [39.95497, -75.16666000000001], [39.954820000000005, -75.16639], [39.95478000000001, -75.16626000000001], [39.95469500174158, -75.1656299994879], [39.95461, -75.165], [39.954600000000006, -75.16475000000001], [39.95452, -75.16474000000001], [39.954530000000005, -75.16467], [39.95447, -75.16458], [39.95439000159216, -75.1639699992383], [39.95431000000001, -75.16336000000001], [39.95436, -75.16334], [39.954280001793165, -75.16269499929398], [39.9542, -75.16205000000001], [39.95427, -75.16204], [39.95413577968321, -75.16095782952313], [39.95400154930486, -75.15987566329385], [39.95386730886503, -75.15879350131246], [39.953733058363824, -75.15771134357924], [39.95359879780133, -75.15662919009446], [39.953464527177616, -75.15554704085842], [39.953330246492776, -75.1544648958714], [39.9531959557469, -75.15338275513366], [39.95306165494008, -75.1523006186455], [39.9529273440724, -75.1512184864072], [39.95279302314393, -75.15013635841903], [39.95265869215479, -75.14905423468129], [39.95252435110506, -75.14797211519425], [39.95239, -75.14689], [39.952450000000006, -75.14687], [39.952450000000006, -75.14679000000001], [39.95313500011528, -75.14666500124312], [39.95382, -75.14654], [39.9542, -75.14641], [39.954096672814984, -75.14556333068857], [39.9539933394711, -75.14471666393548], [39.95389, -75.14387], [39.95384000000001, -75.14388000000001], [39.95373, -75.14303000000001], [39.953720000000004, -75.143], [39.95371000222662, -75.14227999987199], [39.953700000000005, -75.14156000000001], [39.95358, -75.14068], [39.95347, -75.14013], [39.95346, -75.14013], [39.95344, -75.14003000000001], [39.95293500016522, -75.1401950012025], [39.95243000000001, -75.14036], [39.95177, -75.14055], [39.951170000149006, -75.14069666924848], [39.95057000011318, -75.14084333592388], [39.94997, -75.14099], [39.94912250047439, -75.14118500725128], [39.948275000622075, -75.14138000967058], [39.94742750044309, -75.14157500725821], [39.946580000000004, -75.14177000000001], [39.945820000000005, -75.14193], [39.94512, -75.14206], [39.94458999991527, -75.14214000063667], [39.94406, -75.14222000000001]];
    
    const OPTION1_STATIONS = [
      {"name": "Mile 0 (Start)", "miles": 0, "lat": 39.962120000000006, "lon": -75.17641},
      {"name": "Mile 1", "miles": 1, "lat": 39.95631, "lon": -75.16491},
      {"name": "Mile 2", "miles": 2, "lat": 39.94959, "lon": -75.14208},
      {"name": "Mile 3", "miles": 3, "lat": 39.93455, "lon": -75.14326},
      {"name": "Mile 4", "miles": 4, "lat": 39.93968, "lon": -75.15121},
      {"name": "Mile 5", "miles": 5, "lat": 39.94588, "lon": -75.15511},
      {"name": "Mile 6", "miles": 6, "lat": 39.95372, "lon": -75.18259},
      {"name": "Mile 7", "miles": 7, "lat": 39.95936, "lon": -75.18989},
      {"name": "Mile 8", "miles": 8, "lat": 39.97003, "lon": -75.19622},
      {"name": "Mile 9", "miles": 9, "lat": 39.97883, "lon": -75.20318},
      {"name": "Mile 10", "miles": 10, "lat": 39.98485, "lon": -75.20888},
      {"name": "Mile 11", "miles": 11, "lat": 39.98876, "lon": -75.21268},
      {"name": "Mile 12", "miles": 12, "lat": 40.00112, "lon": -75.20484},
      {"name": "Mile 13", "miles": 13, "lat": 40.01189, "lon": -75.21012},
      {"name": "Mile 14", "miles": 14, "lat": 40.02096, "lon": -75.21658},
      {"name": "Mile 15", "miles": 15, "lat": 40.02411, "lon": -75.21970},
      {"name": "Mile 16", "miles": 16, "lat": 40.02373, "lon": -75.21820},
      {"name": "Mile 17", "miles": 17, "lat": 40.01452, "lon": -75.20486},
      {"name": "Mile 18", "miles": 18, "lat": 40.00908, "lon": -75.19692},
      {"name": "Mile 19", "miles": 19, "lat": 40.00229, "lon": -75.19069},
      {"name": "Mile 20", "miles": 20, "lat": 39.99442, "lon": -75.19264},
      {"name": "Mile 21", "miles": 21, "lat": 39.98709, "lon": -75.20074},
      {"name": "Mile 22", "miles": 22, "lat": 39.97946, "lon": -75.19639},
      {"name": "Mile 23", "miles": 23, "lat": 39.97355, "lon": -75.19055},
      {"name": "Mile 24", "miles": 24, "lat": 39.96627, "lon": -75.17912},
      {"name": "Mile 25", "miles": 25, "lat": 39.96273, "lon": -75.17543},
      {"name": "Mile 26", "miles": 26, "lat": 39.96396, "lon": -75.17726}
    ];

    const OPTION2_STATIONS = [
      {"name": "0.0K (Start)", "miles": 0, "lat": 39.962120000000006, "lon": -75.17641},
      {"name": "5.0K (3.1 mi)", "miles": 3.10686, "lat": 39.93455, "lon": -75.14326},
      {"name": "10.0K (6.2 mi)", "miles": 6.21372, "lat": 39.95436, "lon": -75.18098},
      {"name": "15.0K (9.3 mi)", "miles": 9.32058, "lat": 39.97883, "lon": -75.20318},
      {"name": "20.0K (12.4 mi)", "miles": 12.42744, "lat": 40.00112, "lon": -75.20484},
      {"name": "25.0K (15.5 mi)", "miles": 15.5343, "lat": 40.02411, "lon": -75.21970},
      {"name": "30.0K (18.6 mi)", "miles": 18.64116, "lat": 40.00908, "lon": -75.19692},
      {"name": "35.0K (21.7 mi)", "miles": 21.74802, "lat": 39.98709, "lon": -75.20074},
      {"name": "42.2K (Finish)", "miles": 26.2, "lat": 39.96396, "lon": -75.17726}
    ];

    const OPTION3_STATIONS = [
      {"name": "Mile 0 (Start)", "miles": 0, "lat": 39.962120000000006, "lon": -75.17641},
      {"name": "Aid 1 (2.3mi)", "miles": 2.3, "lat": 39.95328878826027, "lon": -75.14007940619219},
      {"name": "Aid 2 (3.7mi)", "miles": 3.7, "lat": 39.93349954347537, "lon": -75.14380023697072},
      {"name": "Aid 3 (5.1mi)", "miles": 5.1, "lat": 39.94682633775574, "lon": -75.1513768255921},
      {"name": "Aid 4 (7.1mi)", "miles": 7.1, "lat": 39.95340381105215, "lon": -75.18428635735891},
      {"name": "Aid 5 (8.5mi)", "miles": 8.5, "lat": 39.96837418476066, "lon": -75.1926544176862},
      {"name": "Aid 6 (10.2mi)", "miles": 10.2, "lat": 39.98012063714047, "lon": -75.2136684863924},
      {"name": "Aid 7 (11.8mi)", "miles": 11.8, "lat": 39.9799695771364, "lon": -75.20644},
      {"name": "Aid 8 (14.4mi)", "miles": 14.4, "lat": 39.96735805301819, "lon": -75.18135690230305},
      {"name": "Aid 9A (16.2mi)", "miles": 16.2, "lat": 39.98468227046648, "lon": -75.20309966931039},
      {"name": "Aid 10A (17.8mi)", "miles": 17.8, "lat": 40.004297874514286, "lon": -75.1907766898945},
      {"name": "Aid 11A (18.9mi)", "miles": 18.9, "lat": 40.013236188052694, "lon": -75.20666064802874},
      {"name": "Aid 12A (19.8mi)", "miles": 19.8, "lat": 40.02167993524602, "lon": -75.2175101067689},
      {"name": "Aid 12B (20.2mi)", "miles": 20.2, "lat": 40.025376716106926, "lon": -75.22323087700566},
      {"name": "Aid 11B (21.3mi)", "miles": 21.3, "lat": 40.01689770265348, "lon": -75.2126331857505},
      {"name": "Mile 26 (Finish)", "miles": 26.2, "lat": 39.96396, "lon": -75.17726}
    ];

    const CORRAL_DATA = [
      { label: "Pushrim Wheelchairs", time: "06:55", minutes: 6*60+55 },
      { label: "Corral A (2:06-2:59)", time: "07:00", minutes: 7*60 },
      { label: "Corral B (3:00-3:29)", time: "07:10", minutes: 7*60+10 },
      { label: "Corral C (3:30-3:44)", time: "07:10", minutes: 7*60+10 },
      { label: "Corral D (3:45-3:59)", time: "07:20", minutes: 7*60+20 },
      { label: "Corral E (4:00)", time: "07:20", minutes: 7*60+20 },
      { label: "Corral F (4:00-4:30)", time: "07:30", minutes: 7*60+30 },
      { label: "Corral G (4:30-4:59)", time: "07:30", minutes: 7*60+30 },
      { label: "Corral H (5:00-7:00)", time: "07:40", minutes: 7*60+40 }
    ];

    // ============================================================
    // STATE & CONFIG
    // ============================================================
    const raceConfig = {
      raceName: "AACR Philadelphia Marathon",
      raceDate: new Date("2025-11-23T07:00:00-05:00"),
      timezone: "America/New_York"
    };

    let currentStationSet = 'option3'; // default to aid stations
    let allStations = {
      option1: OPTION1_STATIONS,
      option2: OPTION2_STATIONS,
      option3: OPTION3_STATIONS
    };
    let raceConfig_stations = OPTION3_STATIONS;
    let stationChanged = false;

    const map = L.map("map").setView([39.962, -75.176], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    let markers = [];
    let groupList = [];
    let currentHighlightIndices = new Set();
    let elevChart = null;

    // ============================================================
    // HELPERS
    // ============================================================
    function haversineMi(from, to) {
      const R = 3959;
      const lat1 = from[0] * Math.PI / 180;
      const lat2 = to[0] * Math.PI / 180;
      const dLat = (to[0] - from[0]) * Math.PI / 180;
      const dLon = (to[1] - from[1]) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
      return R * 2 * Math.asin(Math.sqrt(a));
    }

    function formatElapsedFromMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = Math.floor(mins % 60);
      return `${h}:${m.toString().padStart(2, '0')}`;
    }

    function paceMinPerMiFromUI() {
      const min = parseInt(document.getElementById("paceMin").value) || 0;
      const sec = parseInt(document.getElementById("paceSec").value) || 0;
      return min + sec / 60;
    }

    // ============================================================
    // BUILD MAP AND CHART
    // ============================================================
    function buildMap() {
      // Clear existing markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      groupList = [];

      // Draw route
      const line = L.polyline(PHILLY_ROUTE, {color: "#000", weight: 3}).addTo(map);
      map.fitBounds(line.getBounds());

      // Group stations by lat/lon
      const groupsByKey = {};
      raceConfig_stations.forEach((s, idx) => {
        const key = `${s.lat},${s.lon}`;
        if (!groupsByKey[key]) groupsByKey[key] = { lat:s.lat, lon:s.lon, indices:[] };
        groupsByKey[key].indices.push(idx);
      });
      groupList = Object.values(groupsByKey);

      const blazeIcon = L.divIcon({ className:"", html:'<div class="blaze-dot"></div>', iconSize:[20,20], iconAnchor:[10,10] });
      groupList.forEach((g) => {
        const marker = L.marker([g.lat, g.lon], { icon: blazeIcon }).addTo(map);
        g.marker = marker;
        markers.push(marker);
      });
    }

    function buildElevationChart() {
      // Calculate distances for elevation profile
      const distances = [0];
      for(let i = 1; i < PHILLY_ROUTE.length; i++) {
        distances[i] = distances[i-1] + haversineMi(PHILLY_ROUTE[i-1], PHILLY_ROUTE[i]);
      }
      
      const elevations = distances.map(() => 50 + Math.random() * 100); // placeholder

      const ctx = document.getElementById("elevationChart").getContext("2d");
      if (elevChart) elevChart.destroy();
      
      elevChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: distances.map(d => d.toFixed(1)),
          datasets: [{
            label: "Elevation (ft)",
            data: elevations,
            borderColor: "#003546",
            backgroundColor: "rgba(0,53,70,0.1)",
            fill: true,
            tension: 0.4,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true },
            x: { display: true }
          }
        }
      });
    }

    // ============================================================
    // STATION FREQUENCY TOGGLE
    // ============================================================
    document.querySelectorAll('input[name="stationFreq"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const oldSet = currentStationSet;
        currentStationSet = e.target.value;
        raceConfig_stations = allStations[currentStationSet];
        
        if (oldSet !== currentStationSet) {
          stationChanged = true;
          document.getElementById("paceGo").disabled = true;
          document.getElementById("toggleNote").textContent = "⚠ Station frequency changed. Please regenerate forecast.";
          document.getElementById("forecastBody").innerHTML = "";
        }
        
        buildMap();
        buildElevationChart();
      });
    });

    // ============================================================
    // INITIALIZE UI
    // ============================================================
    document.addEventListener("DOMContentLoaded", () => {
      // Countdown
      const now = new Date();
      const daysLeft = Math.ceil((raceConfig.raceDate - now) / (1000 * 60 * 60 * 24));
      document.getElementById("countdown").textContent = `${daysLeft} days away`;

      // Populate corral dropdown
      const corralSelect = document.getElementById("corralSelect");
      CORRAL_DATA.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.minutes * 60; // seconds
        opt.textContent = `${c.label} (${c.time})`;
        corralSelect.appendChild(opt);
      });

      // Populate pace dropdowns
      const paceMinSelect = document.getElementById("paceMin");
      const paceSecSelect = document.getElementById("paceSec");
      for(let m = 6; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        paceMinSelect.appendChild(opt);
      }
      for(let s = 0; s < 60; s += 15) {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s.toString().padStart(2, '0');
        paceSecSelect.appendChild(opt);
      }
      paceMinSelect.value = 9;
      paceSecSelect.value = 0;

      // Build map and chart
      buildMap();
      buildElevationChart();

      // Forecast button
      document.getElementById("paceGo").addEventListener("click", async () => {
        stationChanged = false;
        document.getElementById("toggleNote").textContent = "";
        document.getElementById("paceGo").disabled = false;
        await updateForecasts();
      });
    });

    async function updateForecasts() {
      const tbody = document.getElementById("forecastBody");
      tbody.innerHTML = "";

      const pace = paceMinPerMiFromUI();
      const startTimeSeconds = parseInt(document.getElementById("corralSelect").value);
      const startTime = new Date(raceConfig.raceDate.getTime() + startTimeSeconds * 1000);
      
      for (const s of raceConfig_stations) {
        const elapsedStr = formatElapsedFromMinutes(s.miles * pace);
        const eta = new Date(startTime.getTime() + s.miles * pace * 60000);
        const timeStr = eta.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"});
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${s.name}</td>
          <td>${s.miles.toFixed(2)} mi</td>
          <td>${elapsedStr}</td>
          <td>${timeStr}</td>
          <td>—</td>
          <td>—</td>
          <td>Forecast ready</td>`;
        tbody.appendChild(row);
      }
    }

    // Row highlighting
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById("forecastBody");
      if (tbody) {
        tbody.addEventListener("pointerup", (e) => {
          const tr = e.target.closest("tr");
          if (!tr) return;
          const was = tr.classList.contains("highlight-row");
          tbody.querySelectorAll("tr").forEach(r => r.classList.remove("highlight-row"));
          if (!was) tr.classList.add("highlight-row");
        }, { passive: true });
      }
    });
  </script>
</body>
</html>
